{% extends "base.html" %}
{% set title = t["history_title"] ~ " | " ~ t["app_name"] %}

{% block content %}
  <section class="backoffice">
    <div class="header">
      <div>
        <p class="badge">{{ t["history_badge"] }}</p>
        <h1>{{ t["history_title"] }}</h1>
        <p class="muted">{{ t["history_lead"] }}</p>
      </div>
    </div>

    <div class="grid">
      <div class="card">
        <h2>{{ t["analysis_recent_title"] }}</h2>
        {% if analyses %}
          <ul class="list">
            {% for item in analyses %}
              <li>
                <strong>{{ t["analysis_status_label"] }}: {{ item["status"] }}</strong>
                <p>{{ t["label_source"] }}: {{ item["source"] }}</p>
                {% if item["score"] %}
                  <p>{{ t["analysis_score_label"] }}: {{ item["score"] }}</p>
                {% endif %}
                {% if item["summary"] %}
                  <p>{{ t["analysis_summary_label"] }}: {{ item["summary"] }}</p>
                {% endif %}
                {% if item["recommendations"] %}
                  <p class="muted">{{ t["analysis_recommendations_label"] }}:</p>
                  <ul class="list">
                    {% for rec in item["recommendations"] %}
                      <li>{{ rec }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
                {% if item["report"] %}
                  <p class="muted">{{ t["analysis_report_label"] }}:</p>
                  <ul class="list">
                    {% for crit in item["report"] %}
                      <li>
                        <strong>{{ crit["label"] }}</strong>
                        <p>{{ t["analysis_report_score"] }}: {{ crit["score"] }}/{{ crit["weight"] }}</p>
                        <p>{{ t["analysis_report_status"] }}: {{ t["analysis_report_pass"] if crit["passed"] else t["analysis_report_fail"] }}</p>
                        <p class="muted">{{ crit["evidence"] }}</p>
                      </li>
                    {% endfor %}
                  </ul>
                {% endif %}
                {% if item["red_flags"] %}
                  <p class="muted">{{ t["analysis_red_flags_label"] }}:</p>
                  <ul class="list">
                    {% for rf in item["red_flags"] %}
                      <li>{{ rf }}</li>
                    {% endfor %}
                  </ul>
                {% endif %}
                <span class="muted">{{ t["label_created_at"] }} {{ item["created_at"] }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">{{ t["analysis_empty"] }}</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>{{ t["chat_history_title"] }}</h2>
        {% if messages %}
          <ul class="list">
            {% for item in messages %}
              <li>
                <strong>
                  {% if item["role"] == "user" %}
                    {{ t["chat_role_user"] }}
                  {% else %}
                    {{ t["chat_role_assistant"] }}
                  {% endif %}
                </strong>
                <p>{{ item["content"] }}</p>
                <span class="muted">{{ t["label_created_at"] }} {{ item["created_at"] }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">{{ t["chat_empty"] }}</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>{{ t["roadmap_recent_title"] }}</h2>
        {% if roadmaps %}
          <ul class="list">
            {% for item in roadmaps %}
              <li>
                <strong>{{ item["title"] }}</strong>
                <p>{{ item["content"] }}</p>
                <span class="muted">{{ t["label_created_at"] }} {{ item["created_at"] }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">{{ t["roadmap_empty"] }}</p>
        {% endif %}
      </div>

      <div class="card">
        <h2>{{ t["insight_recent_title"] }}</h2>
        {% if insights %}
          <ul class="list">
            {% for item in insights %}
              <li>
                <p>{{ item["summary"] }}</p>
                <span class="muted">{{ t["label_created_at"] }} {{ item["created_at"] }}</span>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="muted">{{ t["insight_empty"] }}</p>
        {% endif %}
      </div>
    </div>
  </section>
{% endblock %}
